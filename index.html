 º<!DOCTYPE html>
<html lang="uk">

<head>
    <meta charset="UTF-8">
    <title>IBONARIUM ¬∑ AURA ¬∑ PLANETARY INDEX</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link
        href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&family=Inter:wght@300;400;600&display=swap"
        rel="stylesheet">
    <style>
        /* ------------------------------------------------------------------
           AESTHETIC: DEEP VOID & DATA DENSITY
           ------------------------------------------------------------------ */
        :root {
            --bg-deep: #020205;
            --accent-pri: #80f;
            --accent-sec: #0ff;
            --accent-warn: #f04;
            --white: #eef;
            --glass-panel: rgba(5, 5, 10, 0.85);
            --border-subtle: rgba(100, 100, 255, 0.15);
            --font-mono: 'Space Mono', monospace;
            --font-ui: 'Inter', sans-serif;
            --pad-outer: 40px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: var(--bg-deep);
            color: var(--white);
            font-family: var(--font-mono);
            overflow: hidden;
            height: 100vh;
            font-size: 10px;
        }

        canvas#bg-stars {
            position: fixed;
            inset: 0;
            z-index: 0;
            pointer-events: none;
            opacity: 0.3;
        }

        .app-container {
            position: relative;
            z-index: 10;
            display: grid;
            grid-template-columns: 320px 1fr 320px;
            grid-template-rows: auto 1fr auto;
            gap: 20px;
            height: 100vh;
            padding: var(--pad-outer);
            max-width: 1920px;
            margin: 0 auto;
        }

        .header {
            grid-column: 1 / -1;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            border-bottom: 1px solid var(--border-subtle);
            padding-bottom: 10px;
            margin-bottom: 10px;
        }

        .brand-box {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .brand {
            font-size: 12px;
            letter-spacing: 6px;
            color: var(--accent-sec);
            text-transform: uppercase;
            text-shadow: 0 0 15px rgba(0, 255, 255, 0.3);
        }

        .sub-brand {
            font-size: 9px;
            color: #668;
        }

        .col-left,
        .col-right {
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow-y: auto;
            padding-right: 5px;
        }

        .col-center {
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border: 1px solid var(--border-subtle);
            background: radial-gradient(circle at center, rgba(20, 10, 30, 0.3), transparent 70%);
            border-radius: 4px;
            overflow: hidden;
            /* Ensure canvas doesn't overflow */
        }

        .card {
            background: var(--glass-panel);
            border: 1px solid var(--border-subtle);
            backdrop-filter: blur(10px);
            padding: 12px;
            border-radius: 4px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
        }

        .card-h {
            font-size: 9px;
            color: var(--accent-sec);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
            border-left: 2px solid var(--accent-pri);
            padding-left: 6px;
            display: flex;
            justify-content: space-between;
        }

        .m-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 3px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
            font-size: 9px;
        }

        .m-lbl {
            color: #779;
        }

        .m-val {
            color: #eef;
            font-weight: bold;
        }

        .m-unit {
            color: #556;
            font-size: 8px;
            margin-left: 2px;
        }

        .layer-box {
            background: rgba(255, 255, 255, 0.02);
            padding: 8px;
            margin-bottom: 8px;
            border-left: 3px solid;
        }

        .layer-space {
            border-color: #f80;
        }

        .layer-earth {
            border-color: #0af;
        }

        .layer-human {
            border-color: #f0f;
        }

        .layer-title {
            font-size: 10px;
            font-weight: bold;
            margin-bottom: 6px;
            display: flex;
            justify-content: space-between;
        }

        .layer-score {
            font-size: 18px;
            font-weight: bold;
        }

        canvas#viz-canvas {
            width: 100%;
            height: 100%;
            position: absolute;
            inset: 0;
        }

        .center-hud {
            position: absolute;
            bottom: 20px;
            left: 20px;
            pointer-events: none;
            text-align: left;
        }

        .big-idx {
            font-size: 52px;
            font-weight: 300;
            color: #fff;
            text-shadow: 0 0 30px var(--accent-pri);
            line-height: 1;
        }

        .idx-lbl {
            color: var(--accent-sec);
            font-size: 10px;
            letter-spacing: 2px;
        }

        .log-box {
            font-family: var(--font-ui);
            font-size: 9px;
            color: #88a;
            max-height: 150px;
            overflow-y: auto;
            line-height: 1.4;
        }

        .log-entry {
            margin-bottom: 4px;
            padding-left: 8px;
            border-left: 1px solid #333;
        }

        .log-time {
            color: #556;
            margin-right: 5px;
            font-family: var(--font-mono);
        }

        ::-webkit-scrollbar {
            width: 3px;
        }

        ::-webkit-scrollbar-thumb {
            background: #335;
        }

        /* NEW ALERTS STYLE - TECH/HUD */
        #alert-container {
            position: fixed;
            top: 100px;
            right: 40px;
            /* Aligned with padding */
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 300px;
            pointer-events: none;
        }

        .alert {
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid;
            padding: 10px;
            font-size: 9px;
            font-family: var(--font-mono);
            line-height: 1.4;
            animation: glitch-slide 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) both;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.8);
            position: relative;
            overflow: hidden;
            pointer-events: auto;
        }

        .alert::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: currentColor;
            opacity: 0.5;
            box-shadow: 0 0 10px currentColor;
        }

        .alert-critical {
            border-color: #f04;
            color: #f04;
            background: repeating-linear-gradient(45deg, rgba(255, 0, 0, 0.05), rgba(255, 0, 0, 0.05) 10px, rgba(0, 0, 0, 0.9) 10px, rgba(0, 0, 0, 0.9) 20px);
        }

        .alert-warning {
            border-color: #fa0;
            color: #fa0;
        }

        .alert-info {
            border-color: #0af;
            color: #0af;
        }

        @keyframes glitch-slide {
            0% {
                transform: translateX(50px);
                opacity: 0;
                clip-path: inset(0 100% 0 0);
            }

            20% {
                transform: translateX(-10px);
                opacity: 1;
                clip-path: inset(0 0 0 0);
            }

            40% {
                transform: translateX(5px);
            }

            100% {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .layer-desc {
            font-size: 8px;
            color: #88a;
            margin-top: 6px;
            line-height: 1.4;
            padding: 6px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 2px;
        }

        @media (max-width: 1100px) {
            body {
                overflow-y: auto;
                height: auto;
            }

            .app-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto;
                padding: 10px;
                height: auto;
                display: flex;
                flex-direction: column;
                gap: 10px;
            }

            .col-left,
            .col-right {
                order: 2;
                overflow: visible;
                height: auto;
                padding: 0;
            }

            .col-center {
                order: 1;
                height: 50vh;
                margin: 5px 0;
                min-height: 350px;
            }

            :root {
                --pad-outer: 15px;
            }

            #alert-container {
                top: 60px;
                right: 10px;
                left: 10px;
                max-width: none;
            }
        }
    </style>
</head>

<body>
    <canvas id="bg-stars"></canvas>
    <div id="alert-container"></div>

    <div class="app-container">
        <!-- HEADER -->
        <div class="header">
            <div class="brand-box">
                <div class="brand">IBONARIUM¬∑CHRONOS 7D¬∑PLANETARY.AURA.lavandaaudit.2026</div>
                <div class="sub-brand">PLANETARY CONSCIOUSNESS INDEX ¬∑ GLOBAL AGGREGATE</div>
            </div>
            <div style="text-align:right">
                <div style="font-size:20px; font-weight:bold; color:#fff;" id="clock-main">00:00:00</div>
                <div style="font-size:9px; color:#668;">UTC (GLOBAL)</div>
            </div>
        </div>

        <!-- LEFT COLUMN: SPACE & EARTH LAYERS -->
        <div class="col-left">
            <div class="card">
                <div class="card-h">
                    <span>‚òÄÔ∏è SPACE LAYER</span>
                    <span id="space-status">–°–ò–ù–•–†...</span>
                </div>
                <div class="layer-box layer-space">
                    <div class="layer-title">
                        <span>–ö–û–°–ú–Ü–ß–ù–ê –ù–ï–†–í–û–í–ê –°–ò–°–¢–ï–ú–ê</span>
                        <span class="layer-score" id="space-score">--</span>
                    </div>
                    <div class="m-row">
                        <span class="m-lbl">Kp Index (–≥–µ–æ–º–∞–≥–Ω.)</span>
                        <span class="m-val" id="v-kp">--</span>
                    </div>
                    <div class="m-row">
                        <span class="m-lbl">Solar Wind (–∫–º/—Å)</span>
                        <span class="m-val" id="v-sw-speed">--</span>
                    </div>
                    <div class="m-row">
                        <span class="m-lbl">Density (p/cm¬≥)</span>
                        <span class="m-val" id="v-sw-dens">--</span>
                    </div>
                    <div class="m-row">
                        <span class="m-lbl">Bz IMF (nT)</span>
                        <span class="m-val" id="v-bz">--</span>
                    </div>
                    <div class="m-row">
                        <span class="m-lbl">Bt Total (nT)</span>
                        <span class="m-val" id="v-bt">--</span>
                    </div>
                    <div class="layer-desc" id="space-desc">
                        –û—á—ñ–∫—É–≤–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö –∫–æ—Å–º—ñ—á–Ω–æ—ó –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ...
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-h">
                    <span>üåç EARTH PHYSICAL LAYER (GLOBAL)</span>
                    <span id="earth-status">–°–ò–ù–•–†...</span>
                </div>
                <div class="layer-box layer-earth">
                    <div class="layer-title">
                        <span>–ü–õ–ê–ù–ï–¢–ê–†–ù–ï –¢–Ü–õ–û (AVG)</span>
                        <span class="layer-score" id="earth-score">--</span>
                    </div>
                    <div class="m-row">
                        <span class="m-lbl">Avg Temperature (¬∞C)</span>
                        <span class="m-val" id="v-temp">--</span>
                    </div>
                    <div class="m-row">
                        <span class="m-lbl">Mean Pressure (hPa)</span>
                        <span class="m-val" id="v-press">--</span>
                    </div>
                    <div class="m-row">
                        <span class="m-lbl">Active Zones (Precip)</span>
                        <span class="m-val" id="v-hum">--</span>
                    </div>
                    <div class="m-row">
                        <span class="m-lbl">Global Wind Index</span>
                        <span class="m-val" id="v-wind">--</span>
                    </div>
                    <div class="m-row">
                        <span class="m-lbl">UV Max (Equator)</span>
                        <span class="m-val" id="v-uv">--</span>
                    </div>
                    <div class="m-row">
                        <span class="m-lbl">Atmosphere Stability</span>
                        <span class="m-val" id="v-aqi">--</span>
                    </div>
                    <div class="layer-desc" id="earth-desc">
                        –ê–≥—Ä–µ–≥–∞—Ü—ñ—è –≥–ª–æ–±–∞–ª—å–Ω–∏—Ö –º–µ—Ç–µ–æ–¥–∞–Ω–∏—Ö...
                    </div>
                </div>
            </div>

            <div class="card" style="flex:1">
                <div class="card-h"><span>üìä WEIGHT MATRIX</span></div>
                <div style="font-size:8px; color:#668; line-height:1.6; font-family:var(--font-ui);">
                    <b style="color:#f80;">SPACE</b> = 0.35√óKp + 0.25√óSW_speed + 0.25√ó|Bz| + 0.15√óDensity<br>
                    <b style="color:#0af;">EARTH</b> = Global Avg Metrics (4 key points)<br>
                    <b style="color:#f0f;">HUMAN</b> = 0.40√óSentiment + 0.30√óMarket + 0.30√óSocial<br><br>
                    <b style="color:#80f;">IBONARIUM</b> = 0.4√óSPACE + 0.3√óEARTH + 0.3√óHUMAN
                </div>
            </div>
        </div>

        <!-- CENTER: VISUALIZATION -->
        <div class="col-center">
            <canvas id="viz-canvas"></canvas>

            <div class="center-hud">
                <div class="idx-lbl">IBONARIUM STATE VECTOR</div>
                <div class="big-idx" id="main-idx">--</div>
                <div style="font-size:10px; color:#aaa; margin-top:5px; max-width:280px; min-height:40px;"
                    id="main-desc">
                    –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø –ë–ê–ì–ê–¢–û–®–ê–†–û–í–û–ì–û –ê–ù–ê–õ–Ü–ó–£...
                </div>
            </div>

            <div style="position:absolute; top:20px; right:20px; text-align:right;">
                <div style="font-size:9px; color:#88a;">REAL-TIME PLANETARY STATE</div>
                <div style="font-size:9px; color:#556;">HOLOGRAPHIC PROJECTION</div>
                <div style="margin-top:8px;">
                    <span
                        style="display:inline-block; width:8px; height:8px; background:#f80; margin-right:4px;"></span>
                    <span style="font-size:9px; color:#fff;">SPACE FLUX</span>
                </div>
                <div>
                    <span
                        style="display:inline-block; width:8px; height:8px; background:#0af; margin-right:4px;"></span>
                    <span style="font-size:9px; color:#fff;">EARTH GRID</span>
                </div>
                <div>
                    <span
                        style="display:inline-block; width:8px; height:8px; background:#f0f; margin-right:4px;"></span>
                    <span style="font-size:9px; color:#fff;">HUMAN NODES</span>
                </div>
            </div>
        </div>

        <!-- RIGHT COLUMN: HUMAN LAYER & LOGS -->
        <div class="col-right">
            <div class="card">
                <div class="card-h">
                    <span>üß† HUMAN FIELD LAYER</span>
                    <span id="human-status">–°–ò–ù–•–†...</span>
                </div>
                <div class="layer-box layer-human">
                    <div class="layer-title">
                        <span>–ö–û–õ–ï–ö–¢–ò–í–ù–ê –ü–°–ò–•–Ü–ö–ê</span>
                        <span class="layer-score" id="human-score">--</span>
                    </div>
                    <div class="m-row">
                        <span class="m-lbl">News Sentiment</span>
                        <span class="m-val" id="v-sentiment">--</span>
                    </div>
                    <div class="m-row">
                        <span class="m-lbl">Market Volatility</span>
                        <span class="m-val" id="v-market">--</span>
                    </div>
                    <div class="m-row">
                        <span class="m-lbl">Social Entropy</span>
                        <span class="m-val" id="v-social">--</span>
                    </div>
                    <div class="m-row">
                        <span class="m-lbl">Conflict Proxy</span>
                        <span class="m-val" id="v-conflict">--</span>
                    </div>
                    <div class="layer-desc" id="human-desc">
                        –û—á—ñ–∫—É–≤–∞–Ω–Ω—è —Å–æ—Ü—ñ–∞–ª—å–Ω–∏—Ö –¥–∞–Ω–∏—Ö...
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-h"><span>üìà ANALYTICS</span></div>
                <div class="m-row">
                    <span class="m-lbl">24h Average</span>
                    <span class="m-val" id="m-avg">--</span>
                </div>
                <div class="m-row">
                    <span class="m-lbl">Peak Time</span>
                    <span class="m-val" id="m-peak">--:--</span>
                </div>
                <div class="m-row">
                    <span class="m-lbl">Deviation œÉ</span>
                    <span class="m-val" id="m-dev">--</span>
                </div>
                <div class="m-row">
                    <span class="m-lbl">Trend</span>
                    <span class="m-val" id="m-trend">--</span>
                </div>
            </div>

            <div class="card" style="flex:1; display:flex; flex-direction:column;">
                <div class="card-h"><span>üì° SYSTEM LOG</span></div>
                <div class="log-box" id="sys-log">
                    <!-- Logs -->
                </div>

                <div
                    style="margin-top:15px; padding-top:10px; border-top:1px solid #112; font-size:8px; color:#446; line-height:1.4; font-family:var(--font-ui);">
                    <div style="color:var(--accent-sec); margin-bottom:4px; font-weight:bold; letter-spacing:1px;">
                        IBONARIUM STATE VECTOR v2.1</div>
                    –Ü–Ω—Ç–µ–≥—Ä–∞–ª—å–Ω–∏–π —ñ–Ω–¥–µ–∫—Å –ø–ª–∞–Ω–µ—Ç–∞—Ä–Ω–æ—ó –ø–æ–¥—ñ—ó —á–µ—Ä–µ–∑ –±–∞–≥–∞—Ç–æ—à–∞—Ä–æ–≤—É –∞–≥—Ä–µ–≥–∞—Ü—ñ—é:<br><br>
                    <b style="color:#f80;">–ö–û–°–ú–û–°</b> ‚Äî –Ω–µ—Ä–≤–æ–≤–∞ —Å–∏—Å—Ç–µ–º–∞ (–≥–µ–æ–º–∞–≥–Ω—ñ—Ç–Ω–∞ –∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å, —Å–æ–Ω—è—á–Ω–∏–π –≤—ñ—Ç–µ—Ä)<br>
                    <b style="color:#0af;">–ó–ï–ú–õ–Ø</b> ‚Äî —Ç—ñ–ª–æ (–≥–ª–æ–±–∞–ª—å–Ω–∞ —Å–µ—Ä–µ–¥–Ω—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞, —Ç–∏—Å–∫)<br>
                    <b style="color:#f0f;">–°–û–¶–Ü–£–ú</b> ‚Äî –ø—Å–∏—Ö—ñ–∫–∞ (–Ω–æ–≤–∏–Ω–∏, —Ä–∏–Ω–∫–∏, —Å–æ—Ü—ñ–∞–ª—å–Ω–∞ –∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å)<br><br>
                    –û–Ω–æ–≤–ª–µ–Ω–Ω—è: –ö–æ—Å–º–æ—Å 1—Ö–≤, –ó–µ–º–ª—è 5—Ö–≤, –°–æ—Ü—ñ—É–º 10—Ö–≤
                </div>
            </div>
        </div>

    </div>

    <script>
        // ============================================================================
        // STATE & CONFIG
        // ============================================================================

        const STATE = {
            space: { kp: 0, sw_speed: 0, sw_dens: 0, bz: 0, bt: 0, score: 0 },
            earth: { temp: 0, press: 0, hum: 0, wind: 0, uv: 0, aqi: 0, score: 0 },
            human: { sentiment: 50, market: 0, social: 50, conflict: 0, score: 0 },
            ibonarium: 0,
            history: []
        };

        const MAX_HISTORY = 288; // 24h at 5min intervals

        // DOM
        const elLog = document.getElementById('sys-log');
        const elClock = document.getElementById('clock-main');
        const canvas = document.getElementById('viz-canvas');
        const ctx = canvas.getContext('2d');

        // ============================================================================
        // INIT & LOOPS
        // ============================================================================

        async function init() {
            mockHistory();
            createSpherePoints(); // Initialize new animation points
            setInterval(tickClock, 1000);
            setInterval(fetchSpaceData, 60000); // 1 min
            setInterval(fetchEarthData, 300000); // 5 min
            setInterval(fetchHumanData, 600000); // 10 min
            requestAnimationFrame(animLoop);

            await Promise.all([fetchSpaceData(), fetchEarthData(), fetchHumanData()]);
            calculateIBONARIUM();
            log("IBONARIUM GLOBAL MONITOR ONLINE");
        }

        function mockHistory() {
            const now = Date.now();
            for (let i = MAX_HISTORY; i > 0; i--) {
                const t = now - (i * 5 * 60 * 1000);
                const val = 50 + Math.sin(i / 20) * 20 + (Math.random() - 0.5) * 10;
                STATE.history.push({ t, val: Math.max(0, Math.min(100, val)) });
            }
        }

        // ============================================================================
        // DATA FETCHING
        // ============================================================================

        async function fetchSpaceData() {
            document.getElementById('space-status').innerText = 'FETCH...';
            try {
                const [plasma, mag, kp] = await Promise.all([
                    fetch('https://services.swpc.noaa.gov/products/solar-wind/plasma-5-minute.json')
                        .then(r => r.json())
                        .catch(() => fetch('https://corsproxy.io/?' + encodeURIComponent('https://services.swpc.noaa.gov/products/solar-wind/plasma-5-minute.json')).then(r => r.json())),
                    fetch('https://services.swpc.noaa.gov/products/solar-wind/mag-5-minute.json')
                        .then(r => r.json())
                        .catch(() => fetch('https://corsproxy.io/?' + encodeURIComponent('https://services.swpc.noaa.gov/products/solar-wind/mag-5-minute.json')).then(r => r.json())),
                    fetch('https://services.swpc.noaa.gov/products/noaa-planetary-k-index.json')
                        .then(r => r.json())
                        .catch(() => fetch('https://corsproxy.io/?' + encodeURIComponent('https://services.swpc.noaa.gov/products/noaa-planetary-k-index.json')).then(r => r.json()))
                ]);

                if (plasma && plasma.length > 1) {
                    const l = plasma[plasma.length - 1];
                    STATE.space.sw_dens = parseFloat(l[1]) || 5;
                    STATE.space.sw_speed = parseFloat(l[2]) || 400;
                }

                if (mag && mag.length > 1) {
                    const l = mag[mag.length - 1];
                    STATE.space.bz = parseFloat(l[3]) || 0;
                    STATE.space.bt = parseFloat(l[6]) || 5;
                }

                if (kp && kp.length > 1) {
                    STATE.space.kp = parseFloat(kp[kp.length - 1][1]) || 0;
                }

                // Calculate SPACE score (0-100)
                const kp_norm = Math.min(STATE.space.kp / 9, 1);
                const sw_norm = Math.min(STATE.space.sw_speed / 1000, 1);
                const bz_norm = Math.min(Math.abs(STATE.space.bz) / 25, 1);
                const dens_norm = Math.min(STATE.space.sw_dens / 50, 1);

                STATE.space.score = (
                    0.35 * kp_norm +
                    0.25 * sw_norm +
                    0.25 * bz_norm +
                    0.15 * dens_norm
                ) * 100;

                updateSpaceUI();
                log(`‚úì SPACE: Kp=${STATE.space.kp}, SW=${STATE.space.sw_speed.toFixed(0)} km/s`);
                document.getElementById('space-status').innerText = '–û–ù–õ–ê–ô–ù';
            } catch (e) {
                log('‚ö† SPACE LAYER OFFLINE');
                document.getElementById('space-status').innerText = 'OFFLINE';
            }
        }

        // GLOBAL EARTH FETCH
        async function fetchEarthData() {
            document.getElementById('earth-status').innerText = 'FETCH...';
            try {
                // Fetching 4 strategic points: London (EU), NYC (NA), Tokyo (ASIA), Sydney (AU)
                // to create a "planetary average"
                const locations = [
                    { lat: 51.5, lon: -0.1 },  // London
                    { lat: 40.7, lon: -74.0 }, // NYC
                    { lat: 35.6, lon: 139.7 }, // Tokyo
                    { lat: -33.8, lon: 151.2 } // Sydney
                ];

                const promises = locations.map(loc =>
                    fetch(`https://api.open-meteo.com/v1/forecast?latitude=${loc.lat}&longitude=${loc.lon}&current=temperature_2m,surface_pressure,relative_humidity_2m,wind_speed_10m,uv_index`)
                        .then(r => r.json())
                );

                const results = await Promise.all(promises);

                // Aggregate
                let t_temp = 0, t_press = 0, t_hum = 0, t_wind = 0, t_uv = 0;
                let validCount = 0;

                results.forEach(data => {
                    if (data && data.current) {
                        t_temp += data.current.temperature_2m;
                        t_press += data.current.surface_pressure;
                        t_hum += data.current.relative_humidity_2m;
                        t_wind += data.current.wind_speed_10m;
                        t_uv += data.current.uv_index;
                        validCount++;
                    }
                });

                if (validCount > 0) {
                    STATE.earth.temp = t_temp / validCount;
                    STATE.earth.press = t_press / validCount;
                    STATE.earth.hum = t_hum / validCount;
                    STATE.earth.wind = t_wind / validCount;
                    STATE.earth.uv = t_uv / validCount; // Average UV might be low due to night in some places
                    STATE.earth.aqi = 50; // Still mock
                }

                // Calculate EARTH score (Global)
                // Global average temp baseline roughly 14-16¬∞C
                const temp_dev = Math.abs(STATE.earth.temp - 15) / 20;
                const press_dev = Math.abs(STATE.earth.press - 1013) / 40;
                const uv_norm = STATE.earth.uv / 10;
                const wind_norm = STATE.earth.wind / 25; // Higher tolerance for global avg

                STATE.earth.score = (
                    0.30 * temp_dev +
                    0.20 * press_dev +
                    0.20 * 0.2 + // Static AQI weight
                    0.15 * uv_norm +
                    0.15 * wind_norm
                ) * 100;

                updateEarthUI();
                log(`‚úì EARTH (GLOBAL): Avg T=${STATE.earth.temp.toFixed(1)}¬∞C, P=${STATE.earth.press.toFixed(0)}hPa`);
                document.getElementById('earth-status').innerText = '–û–ù–õ–ê–ô–ù';
            } catch (e) {
                console.error(e);
                log('‚ö† EARTH LAYER OFFLINE (Global Fetch Failed)');
                document.getElementById('earth-status').innerText = 'OFFLINE';
            }
        }

        async function fetchHumanData() {
            document.getElementById('human-status').innerText = 'FETCH...';
            try {
                // News Sentiment
                const newsRes = await fetch('https://api.rss2json.com/v1/api.json?rss_url=http://feeds.bbci.co.uk/news/world/rss.xml');
                const newsData = await newsRes.json();

                let fearWords = ['war', 'dead', 'kill', 'crisis', 'crash', 'attack', 'threat', 'death', 'conflict', 'bomb', 'strike'];
                let hopeWords = ['peace', 'win', 'new', 'safe', 'good', 'growth', 'deal', 'help', 'cure', 'solution'];
                let fearCount = 0, hopeCount = 0;

                newsData.items.slice(0, 15).forEach(item => {
                    const txt = (item.title + " " + item.description).toLowerCase();
                    fearWords.forEach(w => { if (txt.includes(w)) fearCount++; });
                    hopeWords.forEach(w => { if (txt.includes(w)) hopeCount++; });
                });

                STATE.human.sentiment = clamp(50 - (fearCount * 4) + (hopeCount * 3), 10, 90);

                // Market Volatility (Bitcoin - Global Indicator)
                const btcRes = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd&include_24hr_change=true');
                const btcData = await btcRes.json();
                STATE.human.market = Math.abs(btcData.bitcoin.usd_24h_change || 2);

                // Social Entropy
                STATE.human.social = clamp(newsData.items.length * 2, 0, 100);
                STATE.human.conflict = fearCount * 5;

                // Calculate HUMAN score
                const sent_norm = (100 - STATE.human.sentiment) / 100; // inverted
                const market_norm = Math.min(STATE.human.market / 15, 1);
                const social_norm = STATE.human.social / 100;

                STATE.human.score = (
                    0.40 * sent_norm +
                    0.30 * market_norm +
                    0.30 * social_norm
                ) * 100;

                updateHumanUI();
                log(`‚úì HUMAN: Sen=${STATE.human.sentiment.toFixed(0)}, Mkt=${STATE.human.market.toFixed(1)}%`);
                document.getElementById('human-status').innerText = '–û–ù–õ–ê–ô–ù';
            } catch (e) {
                log('‚ö† HUMAN LAYER OFFLINE');
                document.getElementById('human-status').innerText = 'OFFLINE';
            }
        }

        function calculateIBONARIUM() {
            STATE.ibonarium = (
                0.4 * STATE.space.score +
                0.3 * STATE.earth.score +
                0.3 * STATE.human.score
            );

            STATE.history.push({ t: Date.now(), val: STATE.ibonarium });
            if (STATE.history.length > MAX_HISTORY) STATE.history.shift();

            updateMainUI();
        }

        // ============================================================================
        // VISUALIZATION - NEW SPHERE ANIMATION
        // ============================================================================

        let rotationAngle = 0;
        let points = [];

        function createSpherePoints() {
            points = [];
            const count = 300;
            for (let i = 0; i < count; i++) {
                // Fibonacci sphere algorithm
                const y = 1 - (i / (count - 1)) * 2;
                const radiusAtY = Math.sqrt(1 - y * y);
                const theta = i * Math.PI * (3 - Math.sqrt(5)); // Golden angle increment

                const x = Math.cos(theta) * radiusAtY;
                const z = Math.sin(theta) * radiusAtY;

                points.push({
                    x: x * 200,
                    y: y * 200,
                    z: z * 200,
                    xo: x * 200, yo: y * 200, zo: z * 200, // originals
                    phase: Math.random() * Math.PI * 2
                });
            }
        }

        function animLoop() {
            const w = canvas.clientWidth;
            const h = canvas.clientHeight;
            if (canvas.width !== w) { canvas.width = w; canvas.height = h; }

            ctx.clearRect(0, 0, w, h);

            const cx = w / 2;
            const cy = h / 2;

            rotationAngle += 0.002 + (STATE.space.sw_speed / 500000); // Solar wind affects rotation

            // Pulse based on Ibonarium score
            const pulse = 1 + Math.sin(Date.now() / 1000) * (STATE.ibonarium / 500);

            ctx.fillStyle = '#fff';

            // Draw Connections (based on Human Connectivity/Entropy)
            const connectivity = STATE.human.social / 100;

            points.forEach(p => {
                // Rotate
                const x1 = p.x * Math.cos(rotationAngle) - p.z * Math.sin(rotationAngle);
                const z1 = p.x * Math.sin(rotationAngle) + p.z * Math.cos(rotationAngle);

                // Tilt
                const y2 = p.y * Math.cos(0.3) - z1 * Math.sin(0.3);
                const z2 = p.y * Math.sin(0.3) + z1 * Math.cos(0.3);

                // Project
                const scale = 500 / (500 + z2);
                const x3 = x1 * scale * pulse;
                const y3 = y2 * scale * pulse;

                p.sx = cx + x3;
                p.sy = cy + y3;
                p.scale = scale;
                p.z2 = z2;
            });

            // Sort for depth buffer
            points.sort((a, b) => b.z2 - a.z2);

            points.forEach((p, i) => {
                const alpha = Math.max(0.1, p.scale * 0.8);
                const sz = Math.max(0.5, 2 * p.scale);

                // Color based on layer dominance - simplistic mix
                // Mostly white/blue, but tint red if score bad
                let r = 200, g = 200, b = 255;
                if (STATE.ibonarium < 40) { r = 255; g = 50; b = 50; } // Critical

                ctx.fillStyle = `rgba(${r}, ${g}, ${b}, ${alpha})`;
                ctx.beginPath();
                ctx.arc(p.sx, p.sy, sz, 0, Math.PI * 2);
                ctx.fill();

                // Draw lines to neighbors
                if (connectivity > 0.3) {
                    // Connect to a few nearby in array (approximation of spatial nearness in fib sphere)
                    const neighborCount = Math.floor(connectivity * 3);
                    ctx.strokeStyle = `rgba(${r}, ${g}, ${b}, ${alpha * 0.15})`;
                    ctx.lineWidth = 1 * p.scale;

                    for (let j = 1; j <= neighborCount; j++) {
                        const n = points[(i + j) % points.length];
                        // Simple distance check to avoid cross-sphere lines
                        const dx = p.sx - n.sx;
                        const dy = p.sy - n.sy;
                        if (dx * dx + dy * dy < 2500 * p.scale) {
                            ctx.beginPath();
                            ctx.moveTo(p.sx, p.sy);
                            ctx.lineTo(n.sx, n.sy);
                            ctx.stroke();
                        }
                    }
                }
            });

            // Draw Central Core
            const coreSize = 30 * pulse;
            const coreGlow = ctx.createRadialGradient(cx, cy, 0, cx, cy, coreSize * 3);
            coreGlow.addColorStop(0, 'rgba(0, 255, 255, 0.4)');
            coreGlow.addColorStop(1, 'rgba(0,0,0,0)');
            ctx.fillStyle = coreGlow;
            ctx.fillRect(0, 0, w, h);

            // History Graph Overlay
            drawHistory();

            requestAnimationFrame(animLoop);
        }

        function drawHistory() {
            const w = canvas.width;
            const h = canvas.height;
            const graphH = 100;
            const graphY = h - 120; // Above HUD

            if (STATE.history.length < 2) return;

            ctx.strokeStyle = 'rgba(120, 0, 255, 0.5)';
            ctx.lineWidth = 2;
            ctx.beginPath();

            STATE.history.forEach((pt, i) => {
                const x = (i / (MAX_HISTORY)) * w * 0.6 + (w * 0.2); // Centered graph
                const y = graphY + graphH - (pt.val / 100) * graphH;
                i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
            });

            ctx.stroke();
        }


        // ============================================================================
        // UI & ALERTS
        // ============================================================================

        function updateSpaceUI() {
            document.getElementById('v-kp').innerText = STATE.space.kp.toFixed(2);
            document.getElementById('v-sw-speed').innerText = STATE.space.sw_speed.toFixed(0);
            document.getElementById('v-sw-dens').innerText = STATE.space.sw_dens.toFixed(1);
            document.getElementById('v-bz').innerText = STATE.space.bz.toFixed(2);
            document.getElementById('v-bt').innerText = STATE.space.bt.toFixed(2);
            document.getElementById('space-score').innerText = STATE.space.score.toFixed(0);
            document.getElementById('space-score').style.color = getScoreColor(STATE.space.score);

            // Detailed description (Restored)
            let desc = '';
            if (STATE.space.kp > 6) {
                desc = `üî¥ –ì–ï–û–ú–ê–ì–ù–Ü–¢–ù–ò–ô –®–¢–û–†–ú G${Math.floor(STATE.space.kp - 4)}: –°–∏–ª—å–Ω–µ –∑–±—É—Ä–µ–Ω–Ω—è –º–∞–≥–Ω—ñ—Ç–æ—Å—Ñ–µ—Ä–∏ –ó–µ–º–ª—ñ. –ö–†–ò–¢–ò–ß–ù–Ü –†–ò–ó–ò–ö–ò: –ø–æ—Ä—É—à–µ–Ω–Ω—è GPS-–Ω–∞–≤—ñ–≥–∞—Ü—ñ—ó (–≤—ñ–¥—Ö–∏–ª–µ–Ω–Ω—è –¥–æ 50–º), –∑–±–æ—ó –≤ —Ä–∞–¥—ñ–æ–∑–≤'—è–∑–∫—É –Ω–∞ –≤–∏—Å–æ–∫–∏—Ö —à–∏—Ä–æ—Ç–∞—Ö, –º–æ–∂–ª–∏–≤—ñ –ø–µ—Ä–µ–±–æ—ó –≤ –µ–ª–µ–∫—Ç—Ä–æ–º–µ—Ä–µ–∂–∞—Ö, –ø—ñ–¥–≤–∏—â–µ–Ω–∞ —Ä–∞–¥—ñ–∞—Ü—ñ—è –¥–ª—è –∞–≤—ñ–∞—Ä–µ–π—Å—ñ–≤ –Ω–∞ –ø–æ–ª—è—Ä–Ω–∏—Ö –º–∞—Ä—à—Ä—É—Ç–∞—Ö. –†–µ–∫–æ–º–µ–Ω–¥—É—î—Ç—å—Å—è –≤—ñ–¥–∫–ª–∞—Å—Ç–∏ –∫—Ä–∏—Ç–∏—á–Ω—ñ —Å—É–ø—É—Ç–Ω–∏–∫–æ–≤—ñ –æ–ø–µ—Ä–∞—Ü—ñ—ó.`;
            } else if (STATE.space.kp > 4) {
                desc = `üü° –ê–ö–¢–ò–í–ù–ê –§–ê–ó–ê: –ü—ñ–¥–≤–∏—â–µ–Ω–∞ –≥–µ–æ–º–∞–≥–Ω—ñ—Ç–Ω–∞ –∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å (Kp=${STATE.space.kp.toFixed(1)}). –û–ß–Ü–ö–£–Ñ–¢–¨–°–Ø: –ø–æ—Å–∏–ª–µ–Ω–Ω—è –ø–æ–ª—è—Ä–Ω–∏—Ö —Å—è–π–≤ –¥–æ —à–∏—Ä–æ—Ç–∏ 50-55¬∞, –º—ñ–Ω–æ—Ä–Ω—ñ –∑–±–æ—ó –≤ —Å—É–ø—É—Ç–Ω–∏–∫–æ–≤—ñ–π –Ω–∞–≤—ñ–≥–∞—Ü—ñ—ó (—Ç–æ—á–Ω—ñ—Å—Ç—å ¬±10-20–º), –º–æ–∂–ª–∏–≤—ñ —Ñ–ª—É–∫—Ç—É–∞—Ü—ñ—ó –≤ —Ä–æ–±–æ—Ç—ñ HF-—Ä–∞–¥—ñ–æ–∑–≤'—è–∑–∫—É. –ö–æ—Å–º—ñ—á–Ω–∞ –ø–æ–≥–æ–¥–∞ –Ω–µ—Å—Ç–∞–±—ñ–ª—å–Ω–∞.`;
            } else if (STATE.space.kp > 2) {
                desc = `üü¢ –ü–û–ú–Ü–†–ù–ê –ê–ö–¢–ò–í–ù–Ü–°–¢–¨: –ù–æ—Ä–º–∞–ª—å–Ω—ñ –∫–æ–ª–∏–≤–∞–Ω–Ω—è –≥–µ–æ–º–∞–≥–Ω—ñ—Ç–Ω–æ–≥–æ –ø–æ–ª—è (Kp=${STATE.space.kp.toFixed(1)}). –ö–æ—Å–º—ñ—á–Ω–∞ –ø–æ–≥–æ–¥–∞ –≤ –º–µ–∂–∞—Ö –Ω–æ—Ä–º–∏. –ü–æ–ª—è—Ä–Ω—ñ —Å—è–π–≤–∞ –º–æ–∂–ª–∏–≤—ñ –Ω–∞ —à–∏—Ä–æ—Ç–∞—Ö >60¬∞. –í—Å—ñ —Å–∏—Å—Ç–µ–º–∏ –ø—Ä–∞—Ü—é—é—Ç—å —à—Ç–∞—Ç–Ω–æ.`;
            } else {
                desc = `‚ö™ –°–ü–û–ö–Ü–ô: –ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∞ –≥–µ–æ–º–∞–≥–Ω—ñ—Ç–Ω–∞ –∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å (Kp=${STATE.space.kp.toFixed(1)}). –Ü–¥–µ–∞–ª—å–Ω—ñ —É–º–æ–≤–∏ –¥–ª—è –∫–æ—Å–º—ñ—á–Ω–∏—Ö –æ–ø–µ—Ä–∞—Ü—ñ–π, —Å—É–ø—É—Ç–Ω–∏–∫–æ–≤–æ–≥–æ –∑–≤'—è–∑–∫—É —Ç–∞ –Ω–∞–≤—ñ–≥–∞—Ü—ñ—ó. –ú–∞–≥–Ω—ñ—Ç–æ—Å—Ñ–µ—Ä–∞ —Å—Ç–∞–±—ñ–ª—å–Ω–∞.`;
            }

            if (STATE.space.sw_speed > 700) {
                desc += ` ‚ö†Ô∏è –ï–ö–°–¢–†–ï–ú–ê–õ–¨–ù–ò–ô –°–û–ù–Ø–ß–ù–ò–ô –í–Ü–¢–ï–†: ${STATE.space.sw_speed.toFixed(0)} –∫–º/—Å (–Ω–æ—Ä–º–∞ 300-400). –í–∏—Å–æ–∫–æ–µ–Ω–µ—Ä–≥–µ—Ç–∏—á–Ω–∏–π –ø–æ—Ç—ñ–∫ –ø–ª–∞–∑–º–∏ —Å—Ç–∏—Å–∫–∞—î –º–∞–≥–Ω—ñ—Ç–æ—Å—Ñ–µ—Ä—É. –û—á—ñ–∫—É—î—Ç—å—Å—è –ø–æ—Å–∏–ª–µ–Ω–Ω—è –≥–µ–æ–º–∞–≥–Ω—ñ—Ç–Ω–æ—ó –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ –ø—Ä–æ—Ç—è–≥–æ–º 6-12 –≥–æ–¥–∏–Ω.`;
            } else if (STATE.space.sw_speed > 550) {
                desc += ` –®–≤–∏–¥–∫—ñ—Å—Ç—å —Å–æ–Ω—è—á–Ω–æ–≥–æ –≤—ñ—Ç—Ä—É ${STATE.space.sw_speed.toFixed(0)} –∫–º/—Å - –ø—ñ–¥–≤–∏—â–µ–Ω–∏–π –ø–æ—Ç—ñ–∫. –ú–æ–∂–ª–∏–≤–µ –ø–æ—Å–∏–ª–µ–Ω–Ω—è –º–∞–≥–Ω—ñ—Ç–æ—Å—Ñ–µ—Ä–Ω–∏—Ö –∑–±—É—Ä–µ–Ω—å.`;
            }

            if (Math.abs(STATE.space.bz) > 10) {
                const direction = STATE.space.bz < 0 ? '–ø—ñ–≤–¥–µ–Ω–Ω–∞ (–ù–ï–ë–ï–ó–ü–ï–ß–ù–ê)' : '–ø—ñ–≤–Ω—ñ—á–Ω–∞ (—Å—Ç–∞–±—ñ–ª—ñ–∑—É—é—á–∞)';
                desc += ` Bz –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ IMF: ${STATE.space.bz.toFixed(1)} nT (${direction}). ${STATE.space.bz < 0 ? '–ü—ñ–≤–¥–µ–Ω–Ω–∞ –æ—Ä—ñ—î–Ω—Ç–∞—Ü—ñ—è —Å–ø—Ä–∏—è—î –º–∞–≥–Ω—ñ—Ç–Ω–∏–º –±—É—Ä—è–º!' : ''}`;
            }

            document.getElementById('space-desc').innerText = desc;
        }

        function updateEarthUI() {
            document.getElementById('v-temp').innerText = STATE.earth.temp.toFixed(1);
            document.getElementById('v-press').innerText = STATE.earth.press.toFixed(0);
            document.getElementById('v-hum').innerText = STATE.earth.hum.toFixed(0); // Actually Humidity but used as general activity proxy
            document.getElementById('v-wind').innerText = STATE.earth.wind.toFixed(1);
            document.getElementById('v-uv').innerText = STATE.earth.uv.toFixed(1);
            document.getElementById('v-aqi').innerText = STATE.earth.aqi.toFixed(0);
            document.getElementById('earth-score').innerText = STATE.earth.score.toFixed(0);
            document.getElementById('earth-score').style.color = getScoreColor(STATE.earth.score);

            // Detailed description based on global averages
            // Detailed description based on global averages (Restored & Adapted)
            let desc = `üåê –ì–õ–û–ë–ê–õ–¨–ù–ò–ô –°–¢–ê–ù: –°–µ—Ä–µ–¥–Ω—è –ø–ª–∞–Ω–µ—Ç–Ω–∞ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ ${STATE.earth.temp.toFixed(1)}¬∞C. `;

            // Global Temp Analysis
            const tempDiff = STATE.earth.temp - 15;
            if (tempDiff < -5) desc += `(–ì–õ–û–ë–ê–õ–¨–ù–ï –û–•–û–õ–û–î–ñ–ï–ù–ù–Ø). –ó–Ω–∞—á–Ω–µ –≤—ñ–¥—Ö–∏–ª–µ–Ω–Ω—è –≤—ñ–¥ –∫–ª—ñ–º–∞—Ç–∏—á–Ω–æ—ó –Ω–æ—Ä–º–∏. `;
            else if (tempDiff > 5) desc += `(–ì–õ–û–ë–ê–õ–¨–ù–ï –ü–û–¢–ï–ü–õ–Ü–ù–ù–Ø). –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–Ω–∏–π —Ä–µ–∂–∏–º –≤–∏—â–µ –Ω–æ—Ä–º–∏. `;
            else desc += `(–≤ –º–µ–∂–∞—Ö –∫–ª—ñ–º–∞—Ç–∏—á–Ω–æ—ó –Ω–æ—Ä–º–∏). `;

            // Pressure & Atmosphere
            if (Math.abs(STATE.earth.press - 1013) > 15) {
                desc += `‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–Ü –ë–ê–†–ò–ß–ù–Ü –ê–ù–û–ú–ê–õ–Ü–á: ${STATE.earth.press.toFixed(0)} hPa. –ì–ª–æ–±–∞–ª—å–Ω–∞ –∞—Ç–º–æ—Å—Ñ–µ—Ä–Ω–∞ –Ω–µ—Å—Ç–∞–±—ñ–ª—å–Ω—ñ—Å—Ç—å. –†–∏–∑–∏–∫ –µ–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω–∏—Ö –ø–æ–≥–æ–¥–Ω–∏—Ö —è–≤–∏—â —É –∫—ñ–ª—å–∫–æ—Ö —Ä–µ–≥—ñ–æ–Ω–∞—Ö. `;
            } else if (Math.abs(STATE.earth.press - 1013) > 8) {
                desc += `–ü–æ–º—ñ—Ç–Ω—ñ –∫–æ–ª–∏–≤–∞–Ω–Ω—è —Ç–∏—Å–∫—É. –ù–µ—Å—Ç–∞–±—ñ–ª—å–Ω—ñ –∞—Ç–º–æ—Å—Ñ–µ—Ä–Ω—ñ —Ñ—Ä–æ–Ω—Ç–∏. `;
            } else {
                desc += `–ì–ª–æ–±–∞–ª—å–Ω–∏–π –∞—Ç–º–æ—Å—Ñ–µ—Ä–Ω–∏–π —Ç–∏—Å–∫ —Å—Ç–∞–±—ñ–ª—å–Ω–∏–π. `;
            }

            // Wind/energy
            if (STATE.earth.wind > 12) {
                desc += `‚ö†Ô∏è –í–ò–°–û–ö–ê –ö–Ü–ù–ï–¢–ò–ß–ù–ê –ï–ù–ï–†–ì–Ü–Ø –ê–¢–ú–û–°–§–ï–†–ò (–í—ñ—Ç–µ—Ä ${STATE.earth.wind.toFixed(1)} –º/—Å). –¶–∏–∫–ª–æ–Ω—ñ—á–Ω–∞ –∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å –ø—ñ–¥–≤–∏—â–µ–Ω–∞.`;
            } else {
                desc += `–ê—Ç–º–æ—Å—Ñ–µ—Ä–Ω–∞ —Ü–∏—Ä–∫—É–ª—è—Ü—ñ—è –≤ –Ω–æ—Ä–º—ñ.`;
            }

            document.getElementById('earth-desc').innerText = desc;
        }

        function updateHumanUI() {
            document.getElementById('v-sentiment').innerText = STATE.human.sentiment.toFixed(0);
            document.getElementById('v-market').innerText = STATE.human.market.toFixed(1) + '%';
            document.getElementById('v-social').innerText = STATE.human.social.toFixed(0);
            document.getElementById('v-conflict').innerText = STATE.human.conflict.toFixed(0);
            document.getElementById('human-score').innerText = STATE.human.score.toFixed(0);
            document.getElementById('human-score').style.color = getScoreColor(STATE.human.score);

            // Detailed description (Restored Original)
            let desc = '';
            if (STATE.human.sentiment < 30) {
                desc = `üî¥ –ö–†–ò–¢–ò–ß–ù–ò–ô –ù–ï–ì–ê–¢–ò–í (${STATE.human.sentiment.toFixed(0)}/100): –î–æ–º—ñ–Ω—É—é—Ç—å —Ç—Ä–∏–≤–æ–∂–Ω—ñ –Ω–æ–≤–∏–Ω–∏ - –≤—ñ–π–Ω–∞, —Å–º–µ—Ä—Ç—å, –∫—Ä–∏–∑–∏, –∫–∞—Ç–∞—Å—Ç—Ä–æ—Ñ–∏. –ö–û–õ–ï–ö–¢–ò–í–ù–ê –ü–°–ò–•–Ü–ö–ê –ü–Ü–î –¢–ò–°–ö–û–ú. –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ–π–Ω–∏–π –ø—Ä–æ—Å—Ç—ñ—Ä –Ω–∞—Å–∏—á–µ–Ω–∏–π —Å—Ç—Ä–∞—Ö–æ–º —Ç–∞ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç–∞–º–∏. –†–µ–∫–æ–º–µ–Ω–¥—É—î—Ç—å—Å—è –æ–±–º–µ–∂–∏—Ç–∏ —Å–ø–æ–∂–∏–≤–∞–Ω–Ω—è –Ω–æ–≤–∏–Ω –¥–ª—è –º–µ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ –∑–¥–æ—Ä–æ–≤'—è.`;
            } else if (STATE.human.sentiment < 45) {
                desc = `üü° –ü–ï–°–ò–ú–Ü–°–¢–ò–ß–ù–ò–ô –§–û–ù (${STATE.human.sentiment.toFixed(0)}/100): –ü–µ—Ä–µ–≤–∞–∂–∞—é—Ç—å –Ω–µ–≥–∞—Ç–∏–≤–Ω—ñ –ø–æ–¥—ñ—ó –≤ —Å–≤—ñ—Ç–æ–≤–∏—Ö –ó–ú–Ü. –°–æ—Ü—ñ–∞–ª—å–Ω–∞ –Ω–∞–ø—Ä—É–≥–∞ –∑—Ä–æ—Å—Ç–∞—î. –§—ñ–∫—Å—É—î—Ç—å—Å—è –ø—ñ–¥–≤–∏—â–µ–Ω–∞ —Ç—Ä–∏–≤–æ–∂–Ω—ñ—Å—Ç—å —É —Å—É—Å–ø—ñ–ª—å—Å—Ç–≤—ñ. –ü–æ—Ç—Ä—ñ–±–Ω–∞ –∫—Ä–∏—Ç–∏—á–Ω–∞ –æ—Ü—ñ–Ω–∫–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó.`;
            } else if (STATE.human.sentiment < 60) {
                desc = `üü¢ –ù–ï–ô–¢–†–ê–õ–¨–ù–ò–ô –ë–ê–õ–ê–ù–° (${STATE.human.sentiment.toFixed(0)}/100): –ó–º—ñ—à–∞–Ω–∏–π —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ–π–Ω–∏–π –ø–æ—Ç—ñ–∫ - —è–∫ –ø–æ–∑–∏—Ç–∏–≤–Ω—ñ, —Ç–∞–∫ —ñ –Ω–µ–≥–∞—Ç–∏–≤–Ω—ñ –ø–æ–¥—ñ—ó. –°—Ç–∞–±—ñ–ª—å–Ω–∏–π —Å–æ—Ü—ñ–∞–ª—å–Ω–∏–π —Å—Ç–∞–Ω –±–µ–∑ –∫—Ä–∏—Ç–∏—á–Ω–∏—Ö –≤—ñ–¥—Ö–∏–ª–µ–Ω—å.`;
            } else {
                desc = `‚ö™ –û–ü–¢–ò–ú–Ü–°–¢–ò–ß–ù–ò–ô –ù–ê–°–¢–†–Ü–ô (${STATE.human.sentiment.toFixed(0)}/100): –ü–æ–∑–∏—Ç–∏–≤–Ω—ñ –Ω–æ–≤–∏–Ω–∏ –ø–µ—Ä–µ–≤–∞–∂–∞—é—Ç—å - –º–∏—Ä, –¥–æ–ø–æ–º–æ–≥–∞, –ø—Ä–æ–≥—Ä–µ—Å, –¥–æ—Å—è–≥–Ω–µ–Ω–Ω—è. –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω–∏–π —Å–æ—Ü—ñ–∞–ª—å–Ω–∏–π –∫–ª—ñ–º–∞—Ç —Å–ø—Ä–∏—è—î —Ä–æ–∑–≤–∏—Ç–∫—É.`;
            }

            // Market analysis
            if (STATE.human.market > 15) {
                desc += ` ‚ö†Ô∏è –ï–ö–°–¢–†–ï–ú–ê–õ–¨–ù–ê –†–ò–ù–ö–û–í–ê –í–û–õ–ê–¢–ò–õ–¨–ù–Ü–°–¢–¨: ${STATE.human.market.toFixed(1)}% (Bitcoin 24h). –ü–∞–Ω—ñ–∫–∞ –∞–±–æ –µ–π—Ñ–æ—Ä—ñ—è –Ω–∞ –∫—Ä–∏–ø—Ç–æ—Ä–∏–Ω–∫–∞—Ö. –í–∏—Å–æ–∫—ñ —Ä–∏–∑–∏–∫–∏.`;
            } else if (STATE.human.market > 10) {
                desc += ` –í–ò–°–û–ö–ê –≤–æ–ª–∞—Ç–∏–ª—å–Ω—ñ—Å—Ç—å: ${STATE.human.market.toFixed(1)}% (Bitcoin 24h). –ù–µ—Å—Ç–∞–±—ñ–ª—å–Ω—ñ—Å—Ç—å —Ñ—ñ–Ω–∞–Ω—Å–æ–≤–∏—Ö —Ä–∏–Ω–∫—ñ–≤.`;
            } else if (STATE.human.market > 5) {
                desc += ` –ü–æ–º—ñ—Ä–Ω–∞ –≤–æ–ª–∞—Ç–∏–ª—å–Ω—ñ—Å—Ç—å: ${STATE.human.market.toFixed(1)}% (Bitcoin 24h). –ù–æ—Ä–º–∞–ª—å–Ω—ñ —Ä–∏–Ω–∫–æ–≤—ñ –∫–æ–ª–∏–≤–∞–Ω–Ω—è.`;
            } else {
                desc += ` –ù–∏–∑—å–∫–∞ –≤–æ–ª–∞—Ç–∏–ª—å–Ω—ñ—Å—Ç—å: ${STATE.human.market.toFixed(1)}% (Bitcoin 24h). –†–∏–Ω–∫–∏ —Å—Ç–∞–±—ñ–ª—å–Ω—ñ.`;
            }

            document.getElementById('human-desc').innerText = desc;
        }

        function updateMainUI() {
            const idx = STATE.ibonarium;
            document.getElementById('main-idx').innerText = idx.toFixed(1);
            document.getElementById('main-idx').style.color = getScoreColor(idx);

            let mood = "";
            let fullDesc = "";

            if (idx < 30) {
                mood = "–ö–†–ò–¢–ò–ß–ù–ò–ô –°–¢–ê–ù";
                fullDesc = "–ü–ª–∞–Ω–µ—Ç–∞—Ä–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –ø—ñ–¥ –µ–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω–∏–º —Ç–∏—Å–∫–æ–º. –í–∏—Å–æ–∫–∏–π —Ä—ñ–≤–µ–Ω—å –∫–æ—Å–º—ñ—á–Ω–æ—ó –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ, –∞—Ç–º–æ—Å—Ñ–µ—Ä–Ω–∏—Ö –∞–Ω–æ–º–∞–ª—ñ–π —Ç–∞ —Å–æ—Ü—ñ–∞–ª—å–Ω–æ–≥–æ —Å—Ç—Ä–µ—Å—É. –†–µ–∫–æ–º–µ–Ω–¥—É—î—Ç—å—Å—è –ø—ñ–¥–≤–∏—â–µ–Ω–∞ –æ–±–µ—Ä–µ–∂–Ω—ñ—Å—Ç—å.";
            } else if (idx < 50) {
                mood = "–ù–ê–ü–†–£–ñ–ï–ù–ù–Ø";
                fullDesc = "–í–∏—è–≤–ª–µ–Ω–æ –∑–Ω–∞—á–Ω—ñ –≤—ñ–¥—Ö–∏–ª–µ–Ω–Ω—è –≤ –æ–¥–Ω–æ–º—É –∞–±–æ –∫—ñ–ª—å–∫–æ—Ö —à–∞—Ä–∞—Ö. –ü–ª–∞–Ω–µ—Ç–∞—Ä–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –≤ —Å—Ç–∞–Ω—ñ –¥–∏—Å–±–∞–ª–∞–Ω—Å—É. –û—á—ñ–∫—É—î—Ç—å—Å—è –ø–æ—Å–∏–ª–µ–Ω–Ω—è –Ω–µ—Å—Ç–∞–±—ñ–ª—å–Ω–æ—Å—Ç—ñ.";
            } else if (idx < 70) {
                mood = "–°–¢–ê–ë–Ü–õ–¨–ù–Ü–°–¢–¨";
                fullDesc = "–ü–ª–∞–Ω–µ—Ç–∞—Ä–Ω—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ –≤ –º–µ–∂–∞—Ö –Ω–æ—Ä–º–∏. –õ–æ–∫–∞–ª—å–Ω—ñ —Ñ–ª—É–∫—Ç—É–∞—Ü—ñ—ó –ø—Ä–∏—Å—É—Ç–Ω—ñ, –∞–ª–µ –∑–∞–≥–∞–ª—å–Ω–∏–π —Å—Ç–∞–Ω –∫–æ–Ω—Ç—Ä–æ–ª—å–æ–≤–∞–Ω–∏–π. –ù–æ—Ä–º–∞–ª—å–Ω–∏–π —Ä–µ–∂–∏–º —Ñ—É–Ω–∫—Ü—ñ–æ–Ω—É–≤–∞–Ω–Ω—è.";
            } else {
                mood = "–ì–ê–†–ú–û–ù–Ü–Ø";
                fullDesc = "–û–ø—Ç–∏–º–∞–ª—å–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è –≤—Å—ñ—Ö —à–∞—Ä—ñ–≤. –ö–æ—Å–º–æ—Å, –ó–µ–º–ª—è —Ç–∞ –°–æ—Ü—ñ—É–º –≤ –±–∞–ª–∞–Ω—Å—ñ. –°–ø—Ä–∏—è—Ç–ª–∏–≤—ñ —É–º–æ–≤–∏ –¥–ª—è –≤—Å—ñ—Ö –≤–∏–¥—ñ–≤ –¥—ñ—è–ª—å–Ω–æ—Å—Ç—ñ.";
            }

            document.getElementById('main-desc').innerHTML = `<span style="color:#fff; font-weight:bold">${mood}</span> // ${fullDesc}`;

            // Analytics
            const vals = STATE.history.map(h => h.val);
            const avg = vals.reduce((a, b) => a + b, 0) / vals.length;
            const dev = Math.sqrt(vals.map(v => Math.pow(v - avg, 2)).reduce((a, b) => a + b, 0) / vals.length);
            const trend = vals[vals.length - 1] > vals[vals.length - 10] ? '‚Üó UP' : '‚Üò DOWN';

            document.getElementById('m-avg').innerText = avg.toFixed(1);
            document.getElementById('m-dev').innerText = dev.toFixed(1);
            document.getElementById('m-trend').innerText = trend;
            document.getElementById('m-peak').innerText = new Date().toLocaleTimeString('uk-UA', { hour: '2-digit', minute: '2-digit' });

            checkAlerts();
        }

        function getScoreColor(score) {
            if (score < 30) return '#f04';
            if (score < 50) return '#fa0';
            if (score < 70) return '#ff0';
            return '#0fa';
        }

        // ============================================================================
        // ALERT SYSTEM
        // ============================================================================

        const alertContainer = document.getElementById('alert-container');
        const activeAlerts = new Set();

        function showAlert(message, type = 'info', duration = 8000) {
            const alertKey = `${type}-${message}`;
            if (activeAlerts.has(alertKey)) return;

            activeAlerts.add(alertKey);

            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = `[SYSTEM_MSG] >> ${message}`;
            alertContainer.appendChild(alert);

            setTimeout(() => {
                alert.style.opacity = '0';
                setTimeout(() => {
                    if (alert.parentNode) alertContainer.removeChild(alert);
                    activeAlerts.delete(alertKey);
                }, 500);
            }, duration);
        }

        function checkAlerts() {
            // SPACE
            if (STATE.space.kp > 5) showAlert(`MAGNETIC STORM DETECTED (Kp=${STATE.space.kp})`, 'critical');

            // EARTH (Global)
            if (Math.abs(STATE.earth.temp - 15) > 10) showAlert(`GLOBAL TEMP ANOMALY`, 'warning');

            // HUMAN
            if (STATE.human.sentiment < 30) showAlert(`SOCIAL SENTIMENT CRITICAL`, 'critical');
            if (STATE.human.market > 8) showAlert(`MARKET VOLATILITY SPIKE`, 'warning');

            // SYSTEM
            if (STATE.ibonarium < 35) showAlert(`IBONARIUM INDEX LOW`, 'critical');
        }

        // UTILS
        function clamp(v, min, max) { return Math.max(min, Math.min(max, v)); }
        function tickClock() {
            const now = new Date();
            elClock.innerText = now.toLocaleTimeString('uk-UA', { timeZone: 'UTC' }); // Changed to UTC as requested "Planetary" often implies UTC
        }
        function log(msg) {
            const t = new Date().toLocaleTimeString('uk-UA', { hour12: false });
            const d = document.createElement('div');
            d.className = 'log-entry';
            d.innerHTML = `<span class="log-time">[${t}]</span> ${msg}`;
            elLog.prepend(d);
            if (elLog.children.length > 20) elLog.lastChild.remove();
        }

        // Background stars
        const bgC = document.getElementById('bg-stars');
        const bgCtx = bgC.getContext('2d');
        let stars = [];
        for (let i = 0; i < 200; i++) {
            stars.push({
                x: Math.random() * innerWidth,
                y: Math.random() * innerHeight,
                s: Math.random() * 1.5,
                a: Math.random()
            });
        }
        function animStars() {
            bgC.width = innerWidth;
            bgC.height = innerHeight;
            bgCtx.clearRect(0, 0, innerWidth, innerHeight);
            bgCtx.fillStyle = '#fff';
            stars.forEach(s => {
                bgCtx.globalAlpha = s.a * 0.4;
                bgCtx.beginPath();
                bgCtx.arc(s.x, s.y, s.s, 0, Math.PI * 2);
                bgCtx.fill();
                s.y += 0.1;
                if (s.y > innerHeight) s.y = 0;
            });
            requestAnimationFrame(animStars);
        }
        animStars();

        init();
    </script>
</body>

</html>
